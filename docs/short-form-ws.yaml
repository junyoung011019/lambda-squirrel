asyncapi: '2.6.0'
info:
  title: LinkBig Short-Form Learning WebSocket API
  version: '1.0.0'
  description: |
    실시간 학습(WebSocket) API입니다.

    - 사용자는 UUID를 헤더로 인증하여 연결합니다.
    - 메시지를 통해 대화문 입력을 전송하고, DynamoDB에 저장됩니다.
    - 한국어 입력은 자동 피드백(1점)으로 처리됩니다.

servers:
  production:
    url: wss://fzsnpt9u2g.execute-api.us-east-1.amazonaws.com/dev
    protocol: wss
    description: Production WebSocket endpoint

defaultContentType: application/json

channels:
  /$connect:
    description: |
      클라이언트가 서버와 WebSocket 연결을 시작할 때 호출됩니다.
      Authorizer를 통해 `uuid` 헤더로 인증을 수행합니다.
    subscribe:
      summary: 서버 응답
      message:
        contentType: application/json
        payload:
          type: object
          properties:
            statusCode:
              type: integer
              example: 200
            body:
              type: string
              example: "Connected"

  /$disconnect:
    description: |
      클라이언트가 연결을 종료할 때 호출됩니다.
    subscribe:
      summary: 연결 종료 이벤트
      message:
        contentType: application/json
        payload:
          type: object
          properties:
            statusCode:
              type: integer
              example: 200
            body:
              type: string
              example: "Disconnected"

  /sendMessage:
    description: |
      사용자가 학습 메시지를 전송합니다.  
      서버는 DynamoDB에 저장하고, 필요 시 피드백을 생성합니다.
    publish:
      summary: 사용자 → 서버로 메시지 전송
      operationId: sendMessage
      message:
        contentType: application/json
        payload:
          type: object
          required:
            - action
            - lang
            - themeId
            - videoId
            - text
          properties:
            action:
              type: string
              example: sendMessage
            lang:
              type: string
              enum: [KOREAN, ENGLISH, JAPANESE]
              example: KOREAN
            themeId:
              type: string
              example: cafe
            videoId:
              type: string
              example: cafe#1
            text:
              type: string
              example: "죄송합니다. 점심식사를 이미 했어요."
    subscribe:
      summary: 서버 → 사용자 응답 메시지
      operationId: messageSaved
      message:
        contentType: application/json
        payload:
          type: object
          properties:
            message:
              type: string
              example: Message saved successfully

  /processKo:
    description: |
      DynamoDB Streams를 통해 한국어 메시지를 처리하고,  
      처리 결과를 WebSocket으로 사용자에게 전송합니다.
    subscribe:
      summary: 서버 → 사용자 처리 결과 전송
      operationId: processKo
      message:
        contentType: application/json
        payload:
          type: object
          properties:
            status:
              type: string
              enum: [success, error]
              example: success
            lang:
              type: string
              example: KOREAN
            message:
              type: string
              example: "입력이 성공적으로 저장되었습니다."

components:
  securitySchemes:
    uuidAuth:
      type: apiKey
      in: header
      name: uuid
      description: 사용자 UUID 인증 헤더

security:
  - uuidAuth: []
