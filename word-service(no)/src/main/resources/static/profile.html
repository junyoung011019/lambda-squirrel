<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Profile</title>
    <style>
        :root{--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--accent:#2563eb}
        body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
          margin:0;background:linear-gradient(180deg,#f8fafc,#eef2ff);min-height:100vh;display:flex;align-items:center;justify-content:center}
        .card{background:var(--card);border-radius:12px;box-shadow:0 6px 30px rgba(20,30,60,.08);width:920px;max-width:95%;padding:28px;display:grid;grid-template-columns:220px 1fr;gap:20px}
        .avatar{width:160px;height:160px;border-radius:12px;background:linear-gradient(135deg,#eef2ff,#fff);display:flex;align-items:center;justify-content:center;font-size:48px;color:var(--accent);border:1px solid #e6eefc}
        h1{margin:0;font-size:20px}
        p.muted{color:var(--muted);margin:6px 0 18px}
        .field{display:flex;gap:12px;align-items:center;padding:10px 12px;border-radius:8px;background:#fbfdff;border:1px solid #f0f4ff}
        .key{width:160px;color:var(--muted);font-size:13px}
        .val{font-weight:600}
        .actions{margin-top:18px;display:flex;gap:10px;align-items:center}
        button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
        button.secondary{background:transparent;color:var(--accent);border:1px solid #dbeafe}
        pre{background:#0f1724;color:#e6eefc;padding:12px;border-radius:8px;overflow:auto;max-height:240px}
        .notice{font-size:13px;color:#374151;margin-top:10px}
        .col{display:flex;flex-direction:column;gap:10px}
    </style>
</head>
<body>
<main class="card" role="main">
    <div>
        <div class="avatar" id="avatar">ðŸ‘¤</div>
        <h1 id="username">Profile</h1>
        <p class="muted" id="user-sub">User info</p>

        <div class="actions">
            <button id="btn-refresh">Refresh</button>
            <button id="btn-logout" class="secondary">Logout</button>
        </div>

        <p class="notice">This page will try to extract an <code>id_token</code> from the URL hash (implicit flow) or call your backend <code>/me</code> endpoint (code flow / session).</p>
    </div>

    <div class="col">
        <div id="fields" aria-live="polite">
            <!-- dynamic fields inserted here -->
        </div>

        <details open style="margin-top:6px">
            <summary style="cursor:pointer">Raw token / debug</summary>
            <pre id="raw">No token</pre>
        </details>

        <div style="margin-top:12px;">
            <div style="display:flex;gap:8px;align-items:center">
                <input id="code" placeholder="If you received ?code=... paste here to send to /auth/exchange" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eefc">
                <button id="btn-exchange">Exchange code (send to backend)</button>
            </div>
            <p class="muted" style="margin-top:8px">If you are using Authorization Code flow, your backend must exchange <code>code</code> for tokens (this page can't do it securely).</p>
        </div>
    </div>
</main>

<script>
    /* Helper: parse query and hash */
    function parseQuery(qs) {
      const out = {};
      if (!qs) return out;
      qs = qs.replace(/^[?#]/,'');
      for (const part of qs.split(/[&;]/)) {
        const [k,v=''] = part.split('=');
        if (k) out[decodeURIComponent(k)] = decodeURIComponent(v);
      }
      return out;
    }

    /* small JWT decoder (no verification) */
    function decodeJwt(token){
      try{
        const payload = token.split('.')[1];
        const json = atob(payload.replace(/-/g,'+').replace(/_/g,'/'));
        return JSON.parse(decodeURIComponent(escape(json)));
      }catch(e){ return null; }
    }

    /* render user attributes */
    function showUser(obj, rawToken){
      const fields = document.getElementById('fields');
      fields.innerHTML = '';
      const title = document.getElementById('username');
      const subEl = document.getElementById('user-sub');
      const avatar = document.getElementById('avatar');

      if (!obj) {
        title.textContent = 'No user info';
        subEl.textContent = '';
        document.getElementById('raw').textContent = rawToken || 'No token';
        return;
      }

      // pick display name/email/phone
      const name = obj.name || obj.email || obj.preferred_username || obj.username || obj.given_name;
      title.textContent = name || 'Profile';
      subEl.textContent = obj.sub ? 'id: ' + obj.sub : '';

      if (name && name.length>0) {
        avatar.textContent = name.charAt(0).toUpperCase();
      } else {
        avatar.textContent = 'ðŸ‘¤';
      }

      // show commonly useful attributes first
      const order = ['sub','email','email_verified','phone_number','phone_number_verified','preferred_username','name','given_name','family_name','cognito:username'];
      const seen = new Set();

      for (const k of order) {
        if (obj[k] !== undefined) {
          fields.appendChild(makeRow(k, String(obj[k])));
          seen.add(k);
        }
      }
      // other keys
      for (const k of Object.keys(obj).sort()) {
        if (seen.has(k)) continue;
        fields.appendChild(makeRow(k, JSON.stringify(obj[k])));
      }

      document.getElementById('raw').textContent = rawToken || JSON.stringify(obj, null, 2);
    }

    function makeRow(k, v){
      const wrap = document.createElement('div');
      wrap.className = 'field';
      const key = document.createElement('div');
      key.className = 'key';
      key.textContent = k;
      const val = document.createElement('div');
      val.className = 'val';
      val.textContent = v;
      wrap.appendChild(key); wrap.appendChild(val);
      return wrap;
    }

    /* Try several strategies to obtain user info:
       1) if URL hash contains id_token -> decode and show
       2) if query has code -> show code (and let user send to backend)
       3) try GET /me (if backend provides session-aware endpoint)
    */
    async function init(){
      const hash = window.location.hash ? window.location.hash.substring(1) : '';
      const qHash = parseQuery(hash);
      const q = parseQuery(window.location.search);

      // 1) implicit / id_token in hash
      if (qHash.id_token) {
        const token = qHash.id_token;
        const payload = decodeJwt(token);
        showUser(payload, token);
        return;
      }

      // 2) if code present, show code and allow exchange
      if (q.code) {
        document.getElementById('code').value = q.code;
        document.getElementById('raw').textContent = 'Authorization code present. Click "Exchange code" to POST to /auth/exchange (server should handle securely).';
        showUser(null, null);
        return;
      }

      // 3) try backend endpoint
      try {
        const res = await fetch('/me', {credentials:'include'}); // expects session cookie
        if (res.ok) {
          const json = await res.json();
          // json expected to be user claims
          showUser(json, JSON.stringify(json, null, 2));
          return;
        } else {
          // not found or unauthorized
          showUser(null, null);
        }
      } catch(e){
        showUser(null, null);
      }
    }

    document.getElementById('btn-refresh').addEventListener('click', init);
    document.getElementById('btn-logout').addEventListener('click', async ()=>{
      // try to call backend logout, else redirect to hosted ui logout
      try {
        await fetch('/auth/logout', {method:'POST', credentials:'include'});
        window.location.href = '/';
      } catch(e){
        // fallback: redirect to Cognito logout endpoint (replace {COGNITO_LOGOUT_URL})
        window.location.href = '{COGNITO_LOGOUT_URL}';
      }
    });

    document.getElementById('btn-exchange').addEventListener('click', async ()=>{
      const code = document.getElementById('code').value.trim();
      if (!code) return alert('Paste the authorization code first.');
      // send code to backend to exchange for tokens
      // backend endpoint example: POST /auth/exchange { code }
      try {
        const r = await fetch('/auth/exchange', {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ code }),
          credentials:'include'
        });
        if (r.ok) {
          alert('Exchanged successfully. Reloading profile...');
          await init();
        } else {
          const txt = await r.text();
          alert('Exchange failed: ' + txt);
        }
      } catch(e){
        alert('Network error: ' + e.message);
      }
    });

    init();
</script>
</body>
</html>
